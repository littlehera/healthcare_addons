[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2024-05-21 17:58:12.843349",
  "module": "Healthcare Add-ons",
  "name": "Sales Invoice - Healthcare Add-ons",
  "script": "frappe.ui.form.on('Sales Invoice', {\n\trefresh(frm) {\n\t\t// your code here\n\t},\n\tonload(frm){\n\t    practitioner_set_query(frm);\n\t    set_hmo_visibility(frm);\n\t    show_hide_ref_practitioner(frm);\n\t    if(frappe.user.has_role(\"Sales Manager\")){\n\t       frm.set_df_property(\"set_posting_time\", \"hidden\", 0);\n\t    }\n\t    else{\n\t        frm.set_df_property(\"set_posting_time\", \"hidden\", 1);\n\t    }\n\t}\n})\n\nfrappe.ui.form.on(\"Sales Invoice\", \"sales_partner\", function(frm){\n    reset_sales_partner(frm);\n});\n\nfrappe.ui.form.on('Sales Invoice', 'ref_practitioner', function(frm){\n    reset_sales_partner(frm);\n    if(frm.doc.ref_practitioner)\n        frappe.call({\n            \"method\": \"frappe.client.get\",\n            \"args\":{\n                doctype: \"Healthcare Practitioner\",\n                name: frm.doc.ref_practitioner\n            },\n            \"callback\":function(data){\n                var practitioner_type = data.message['custom_type'];\n                var practitioner_name = data.message['practitioner_name'];\n                if(practitioner_type == 'Doctor (MD)'){\n                    practitioner_name += ', MD';\n                }\n                frm.set_value(\"custom_practitioner_name\",practitioner_name);\n                \n                if(frm.doc.custom_source.includes(\"Doctor's Referral\")||frm.doc.custom_source.includes(\"Promo\"))\n                    frm.set_value(\"sales_partner\",data.message['custom_sales_partner']);\n            }\n        });\n});\n\nfrappe.ui.form.on('Sales Invoice', 'custom_external_referrer', function(frm){\n    reset_sales_partner(frm);\n    if(frm.doc.custom_external_referrer)\n        frappe.call({\n            \"method\": \"frappe.client.get\",\n            \"args\":{\n                doctype: \"External Referrer\",\n                name: frm.doc.custom_external_referrer\n            },\n            \"callback\":function(data){\n                frm.set_value(\"sales_partner\",data.message['sales_partner']);\n            }\n        });\n});\n\nfrappe.ui.form.on('Sales Invoice', 'custom_source', function(frm){\n   show_hide_ref_practitioner(frm);\n   set_hmo_visibility(frm);\n   \n   var si_source = frm.doc.custom_source;\n   if(si_source.includes(\"SC/PWD\")){\n        frm.set_value(\"additional_discount_percentage\",20);\n   }\n   else if(si_source.includes(\"MD\")){\n        frm.set_value(\"additional_discount_percentage\",10);\n   }\n   else{\n       frm.set_value(\"additional_discount_percentage\",0);\n   }\n});\n\nfrappe.ui.form.on('Sales Invoice', 'custom_hmo', function(frm){\n    if(frm.doc.custom_hmo)\n        frappe.call({\n            \"method\": \"frappe.client.get\",\n            \"args\":{\n                doctype: \"HMO\",\n                name: frm.doc.custom_hmo\n            },\n            \"callback\":function(data){\n                var price_list = data.message['price_list'];\n                \n                frm.set_value(\"selling_price_list\",price_list);\n            }\n        });\n});\n\nfrappe.ui.form.on(\"Sales Invoice\", \"custom_source\", function(frm) {\n        practitioner_set_query(frm);\n    \n});\n\nfrappe.ui.form.on(\"Invoice Payment Table\",'custom_invoice_payments_add', function(frm){\n    console.log(\"ADD\");\n    get_payment_balance(frm);\n});\n\nfrappe.ui.form.on(\"Invoice Payment Table\",'custom_invoice_payments_remove', function(frm){\n    console.log(\"REMOVE\")\n    get_payment_balance(frm);\n});\n\nfrappe.ui.form.on(\"Invoice Payment Table\",'amount', function(frm,cdt,cdn){\n    console.log(\"amount\");\n    update_payment_balance(frm);\n});\n\nfunction practitioner_set_query(frm){\n    \n    var filters = {};\n    \n    if(frm.doc.custom_source.includes(\"Doctor's Referral\")||frm.doc.custom_source.includes(\"Promo\")){\n        filters = {\"custom_type\": \"Doctor (MD)\"}\n    }\n\n    frm.set_query(\"ref_practitioner\", function() {\n        return {\n            \"filters\": filters\n        };\n    });\n}\n\nfunction show_hide_ref_practitioner(frm){\n    if(frm.doc.custom_source.includes(\"Doctor's Referral\") ||frm.doc.custom_source.includes(\"Promo\") || frm.doc.custom_source.includes(\"HMO\")){\n        frm.set_df_property(\"ref_practitioner\", \"hidden\", 0);\n        frm.set_df_property(\"ref_practitioner\", \"read_only\", 0);\n        if(!frm.doc.custom_source.includes(\"Promo\")){\n            frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 1);\n            frm.set_df_property(\"ref_practitioner\", \"reqd\", 1);\n        }\n        else{\n            frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 0);\n            frm.set_df_property(\"ref_practitioner\", \"reqd\", 0);\n        }\n        \n        frm.set_df_property(\"custom_practitioner_name\", \"hidden\", 0);\n        frm.set_df_property(\"custom_practitioner_name\", \"read_only\", 0);\n        \n    }\n    else{\n        frm.set_value(\"ref_practitioner\",\"\");\n        frm.set_df_property(\"ref_practitioner\", \"hidden\", 1);\n        frm.set_df_property(\"ref_practitioner\", \"read_only\", 1);\n        frm.set_df_property(\"ref_practitioner\", \"reqd\", 0);\n        frm.set_value(\"custom_practitioner_name\",\"\");\n        frm.set_df_property(\"custom_practitioner_name\", \"hidden\", 1);\n        frm.set_df_property(\"custom_practitioner_name\", \"read_only\", 1);\n        frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 0);\n    }\n}\n\nfunction set_hmo_visibility(frm){\n    if(frm.doc.custom_source.includes(\"HMO\")){\n        frm.set_df_property(\"custom_hmo\", \"hidden\", 0);\n        frm.set_df_property(\"custom_hmo\", \"read_only\", 0);\n        frm.set_df_property(\"custom_hmo\", \"reqd\", 1);\n    }\n    else{\n        frm.set_df_property(\"custom_hmo\", \"hidden\", 1);\n        frm.set_df_property(\"custom_hmo\", \"read_only\", 1);\n        frm.set_df_property(\"custom_hmo\", \"reqd\", 0);\n    }\n    \n}\n\nfunction reset_sales_partner(frm){\n    frm.set_value(\"commission_rate\",0);\n    frm.set_value(\"total_commission\",0);    \n}\n\nfunction get_payment_balance(frm){\n    var total_payments = 0;\n    var grand_total = frm.doc.grand_total;\n    var invoice_payments = frm.doc.custom_invoice_payments;\n    var balance_amount = 0;\n    \n    for(var i=0; i<invoice_payments.length; i++){\n        if(typeof invoice_payments[i]==\"undefined\"){\n        }\n        else{\n            if(\"amount\" in invoice_payments[i])\n                if(invoice_payments[i].amount>0)\n                    total_payments += invoice_payments[i].amount;\n        }\n            \n    }\n    \n    balance_amount = grand_total - total_payments;\n    \n    for(var j=0; j<invoice_payments.length; j++){\n        console.log(invoice_payments[j].amount+\"| invoice_pmt amount\");\n        if((invoice_payments[j].amount == undefined)||(invoice_payments[j].amount==0))\n            frappe.model.set_value(invoice_payments[j].doctype, invoice_payments[j].name, 'amount', balance_amount)\n        frm.refresh_field('custom_invoice_payments');\n    }\n    \n    update_payment_balance(frm);\n    \n}\n\nfunction set_payment_balance(frm,balance){\n    \n}\n\nfunction update_payment_balance(frm){\n    var total_payments = 0;\n    var grand_total = frm.doc.grand_total;\n    var invoice_payments = frm.doc.custom_invoice_payments;\n    var balance_amount = 0;\n    \n    for(var i=0; i<invoice_payments.length; i++){\n            total_payments += invoice_payments[i].amount;\n    }\n    \n    frm.set_value(\"custom_payments_total\", total_payments);\n    \n}",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lab Test",
  "enabled": 1,
  "modified": "2024-05-12 20:23:10.572834",
  "module": "Healthcare Add-ons",
  "name": "Lab Test Script",
  "script": "cur_frm.add_fetch(\"custom_sales_invoice\",\"patient\",\"patient\")\n\nfrappe.ui.form.on('Lab Test', {\n\trefresh(frm) {\n\t\tfrm.set_query(\"custom_radiologist\", function() {\n        return {\n            \"filters\": {\n                \"custom_type\": \"Radiologist\"\n            }\n        };\n    });\n    \t\tfrm.set_query(\"custom_sales_invoice\", function() {\n        return {\n            \"filters\": {\n                \"docstatus\": \"1\"\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on(\"Lab Test\",\"custom_radiologist\",function(frm){\n    if(frm.doc.custom_radiologist)\n    frappe.call({\n        \"method\":\"frappe.client.get\",\n        \"args\":{\n            \"doctype\":\"Healthcare Practitioner\",\n            \"name\":frm.doc.custom_radiologist\n        },\n        callback:function(r){\n            if(r.message){\n                frm.set_value(\"custom_radiologist_name\",r.message.practitioner_name)\n            }\n        }\n    });\n    else{\n        frm.set_value(\"custom_radiologist_name\",\"\")\n    }\n})",
  "view": "Form"
 }
]