[
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Patient",
  "enabled": 1,
  "modified": "2024-08-11 18:47:27.253327",
  "module": "Healthcare Add-ons",
  "name": "Patient Script",
  "script": "frappe.ui.form.on('Patient', {\n\trefresh(frm) {\n\t\t// your code here\n\t}\n})\n\nfrappe.ui.form.on('Patient', {\n    refresh: function (frm) {\n        frm.add_custom_button(__('Update Patient Details'), function () {\n        \tvar progress_bar = '<span id=\"progress_bar_text\">Updating...</span><div class=\"progress\">' +\n        \t\t'<div id = \"progress_bar\" class=\"progress-bar progress-bar-info progress-bar-striped active\" role=\"progressbar\" aria-valuenow=\"01\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width:100%\">' +\n        \t\t'</div></div>';\n        \tvar progress = new frappe.ui.Dialog({\n        \t\ttitle: \"Loading...\",\n        \t\tfields: [\n        \t\t\t{\"fieldtype\": \"HTML\", \"fieldname\": \"progress\"}]\n        \t});\n        \tprogress.fields_dict.progress.$wrapper.html(progress_bar);\n        \tprogress.show()\n            frappe.call({\n                'method': \"healthcare_addons.public.python.patevents.update_patient_details\",\n                'args':{\n                    doc: frm.doc\n                },\n                'callback': function(d){\n                    if(d.message){\n                        progress.hide();\n                        frappe.msgprint(d.message);\n                    }\n                }   \n            });\n        });\n    }\n});\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Sales Invoice",
  "enabled": 1,
  "modified": "2026-02-22 18:18:28.361146",
  "module": "Healthcare Add-ons",
  "name": "Sales Invoice - Healthcare Add-ons",
  "script": "frappe.ui.form.on('Sales Invoice', {\r\n\trefresh(frm) {\r\n\t\t// your code here\r\n\t},\r\n\tonload(frm){\r\n\t    practitioner_set_query(frm);\r\n\t    set_hmo_visibility(frm);\r\n\t    show_hide_ref_practitioner(frm);\r\n\t    if(frappe.user.has_role(\"Sales Manager\")){\r\n\t       frm.set_df_property(\"set_posting_time\", \"hidden\", 0);\r\n\t    }\r\n\t    else{\r\n\t        frm.set_df_property(\"set_posting_time\", \"hidden\", 1);\r\n\t    }\r\n\t}\r\n})\r\n\r\nfrappe.ui.form.on(\"Sales Invoice\", \"sales_partner\", function(frm){\r\n    frm.set_value(\"commission_rate\",0);\r\n    frm.set_value(\"total_commission\",0);\r\n});\r\n\r\nfrappe.ui.form.on('Sales Invoice', 'ref_practitioner', function(frm){\r\n    reset_sales_partner(frm);\r\n    if(frm.doc.ref_practitioner)\r\n        frappe.call({\r\n            \"method\": \"frappe.client.get\",\r\n            \"args\":{\r\n                doctype: \"Healthcare Practitioner\",\r\n                name: frm.doc.ref_practitioner\r\n            },\r\n            \"callback\":function(data){\r\n                var practitioner_type = data.message['custom_type'];\r\n                var practitioner_name = data.message['practitioner_name'];\r\n                if(practitioner_type == 'Doctor (MD)'){\r\n                    practitioner_name += ', MD';\r\n                }\r\n                frm.set_value(\"custom_practitioner_name\",practitioner_name);\r\n\r\n                if(frm.doc.custom_source.includes(\"HMO\")||frm.doc.custom_source.includes(\"Doctor's Referral\")||frm.doc.custom_source.includes(\"Promo\"))\r\n                    frm.set_value(\"sales_partner\",data.message['custom_sales_partner']);\r\n            }\r\n        });\r\n});\r\n\r\nfrappe.ui.form.on('Sales Invoice', 'custom_external_referrer', function(frm){\r\n    reset_sales_partner(frm);\r\n    if(frm.doc.custom_external_referrer)\r\n        frappe.call({\r\n            \"method\": \"frappe.client.get\",\r\n            \"args\":{\r\n                doctype: \"External Referrer\",\r\n                name: frm.doc.custom_external_referrer\r\n            },\r\n            \"callback\":function(data){\r\n                frm.set_value(\"sales_partner\",data.message['sales_partner']);\r\n            }\r\n        });\r\n});\r\n\r\nfrappe.ui.form.on('Sales Invoice', 'custom_source', function(frm){\r\n   reset_sales_partner(frm)\r\n   show_hide_ref_practitioner(frm);\r\n   set_hmo_visibility(frm);\r\n\r\n   frm.set_value(\"ref_practitioner\",\"\");\r\n   frm.set_value(\"custom_practitioner_name\",\"\");\r\n\r\n   var si_source = frm.doc.custom_source;\r\n   if(si_source.includes(\"SC/PWD\")){\r\n        frm.set_value(\"additional_discount_percentage\",20);\r\n   }\r\n   else if(si_source.includes(\"MD\")){\r\n        frm.set_value(\"additional_discount_percentage\",10);\r\n   }\r\n   else{\r\n       frm.set_value(\"additional_discount_percentage\",0);\r\n   }\r\n});\r\n\r\nfrappe.ui.form.on('Sales Invoice', 'custom_hmo', function(frm){\r\n    if(frm.doc.custom_hmo)\r\n        frappe.call({\r\n            \"method\": \"frappe.client.get\",\r\n            \"args\":{\r\n                doctype: \"HMO\",\r\n                name: frm.doc.custom_hmo\r\n            },\r\n            \"callback\":function(data){\r\n                var price_list = data.message['price_list'];\r\n\r\n                frm.set_value(\"selling_price_list\",price_list);\r\n            }\r\n        });\r\n});\r\n\r\nfrappe.ui.form.on(\"Sales Invoice\", \"custom_source\", function(frm) {\r\n        practitioner_set_query(frm);\r\n\r\n});\r\n\r\nfrappe.ui.form.on(\"Sales Invoice\", \"custom_calculate_vat\", function(frm,cdt,cdn) {\r\n    console.log(\"SI AMOUNT\");\r\n    var si_source = frm.doc.custom_source;\r\n    var addtl_disc = parseFloat(frm.doc.custom_additional_discount);\r\n    var net_of_vat = frm.doc.total/1.12;\r\n    var vat = frm.doc.total - net_of_vat;\r\n    var less_discount = net_of_vat * (frm.doc.additional_discount_percentage/100);\r\n\t\tvar addtl_disc_amount = (net_of_vat - less_discount)*(addtl_disc/100);\r\n\t\tvar total_discount = less_discount + addtl_disc_amount;\r\n    if(si_source.includes(\"SC/PWD\")){\r\n       frm.set_value(\"custom_vat_amount\", vat);\r\n       frm.set_value(\"custom_net_of_vat\", net_of_vat);\r\n       frm.set_value(\"custom_less_discount\", less_discount);\r\n       frm.set_value(\"custom_add_vat\",0);\r\n       frm.set_value(\"custom_amount_due\", (net_of_vat - less_discount));\r\n\t\t\t frm.set_value(\"custom_additional_discount_amount\", addtl_disc_amount);\r\n\t\t\t frm.set_value(\"custom_total_discount\",total_discount);\r\n\t\t\t frm.set_value(\"custom_final_amount_due\", (net_of_vat - total_discount));\r\n\t\t\t if(addtl_disc_amount > 0){\r\n\t\t\t\t add_employee_benefit_row(frm, addtl_disc_amount);\r\n\t\t\t }\r\n   }\r\n   else{\r\n       frm.set_value(\"custom_vat_amount\", vat);\r\n       frm.set_value(\"custom_net_of_vat\", net_of_vat);\r\n       frm.set_value(\"custom_less_discount\", less_discount);\r\n       frm.set_value(\"custom_add_vat\", vat);\r\n       frm.set_value(\"custom_amount_due\", (net_of_vat - less_discount + vat));\r\n\t\t\t frm.set_value(\"custom_additional_discount_amount\", addtl_disc_amount);\r\n\t\t\t frm.set_value(\"custom_total_discount\",total_discount);\r\n\t\t\t frm.set_value(\"custom_final_amount_due\", (net_of_vat - total_discount + vat));\r\n\t\t\t if(addtl_disc_amount > 0){\r\n\t\t\t\t add_employee_benefit_row(frm, addtl_disc_amount);\r\n\t\t\t }\r\n   }\r\n});\r\n\r\nfrappe.ui.form.on(\"Invoice Payment Table\",'custom_invoice_payments_add', function(frm){\r\n    console.log(\"ADD\");\r\n    get_payment_balance(frm);\r\n});\r\n\r\nfrappe.ui.form.on(\"Invoice Payment Table\",'custom_invoice_payments_remove', function(frm){\r\n    console.log(\"REMOVE\")\r\n    get_payment_balance(frm);\r\n});\r\n\r\nfrappe.ui.form.on(\"Invoice Payment Table\",'amount', function(frm,cdt,cdn){\r\n    console.log(\"amount\");\r\n    update_payment_balance(frm);\r\n});\r\n\r\nfrappe.ui.form.on(\"Invoice Payment Table\",'ref_no', function(frm, cdt, cdn){\r\n    var or_no = locals[cdt][cdn].ref_no;\r\n    var no_space = or_no.replace(' ','');\r\n    console.log(or_no, no_space);\r\n    frappe.model.set_value(cdt,cdn,'ref_no',no_space);\r\n    frm.refresh_field('custom_invoice_payments')\r\n\r\n\r\n});\r\n\r\nfunction practitioner_set_query(frm){\r\n\r\n    var filters = {};\r\n\r\n    if(frm.doc.custom_source.includes(\"Doctor's Referral\")||frm.doc.custom_source.includes(\"Promo\")){\r\n        filters = {\"custom_type\": \"Doctor (MD)\"}\r\n    }\r\n\r\n    frm.set_query(\"ref_practitioner\", function() {\r\n        return {\r\n            \"filters\": filters\r\n        };\r\n    });\r\n}\r\n\r\nfunction show_hide_ref_practitioner(frm){\r\n    if(frm.doc.custom_source.includes(\"Doctor's Referral\") ||frm.doc.custom_source.includes(\"Promo\") || frm.doc.custom_source.includes(\"HMO\")){\r\n        frm.set_df_property(\"ref_practitioner\", \"hidden\", 0);\r\n        frm.set_df_property(\"ref_practitioner\", \"read_only\", 0);\r\n        if(!frm.doc.custom_source.includes(\"Promo\")){\r\n            frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 1);\r\n            frm.set_df_property(\"ref_practitioner\", \"reqd\", 1);\r\n        }\r\n        else{\r\n            frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 0);\r\n            frm.set_df_property(\"ref_practitioner\", \"reqd\", 0);\r\n        }\r\n\r\n        frm.set_df_property(\"custom_practitioner_name\", \"hidden\", 0);\r\n        frm.set_df_property(\"custom_practitioner_name\", \"read_only\", 0);\r\n\r\n    }\r\n    else{\r\n        frm.set_value(\"ref_practitioner\",\"\");\r\n        frm.set_df_property(\"ref_practitioner\", \"hidden\", 1);\r\n        frm.set_df_property(\"ref_practitioner\", \"read_only\", 1);\r\n        frm.set_df_property(\"ref_practitioner\", \"reqd\", 0);\r\n        frm.set_value(\"custom_practitioner_name\",\"\");\r\n        frm.set_df_property(\"custom_practitioner_name\", \"hidden\", 1);\r\n        frm.set_df_property(\"custom_practitioner_name\", \"read_only\", 1);\r\n        frm.set_df_property(\"custom_practitioner_name\", \"reqd\", 0);\r\n    }\r\n}\r\n\r\nfunction set_hmo_visibility(frm){\r\n    if(frm.doc.custom_source.includes(\"HMO\")){\r\n        frm.set_df_property(\"custom_hmo\", \"hidden\", 0);\r\n        frm.set_df_property(\"custom_hmo\", \"read_only\", 0);\r\n        frm.set_df_property(\"custom_hmo\", \"reqd\", 1);\r\n    }\r\n    else{\r\n        frm.set_df_property(\"custom_hmo\", \"hidden\", 1);\r\n        frm.set_df_property(\"custom_hmo\", \"read_only\", 1);\r\n        frm.set_df_property(\"custom_hmo\", \"reqd\", 0);\r\n    }\r\n\r\n}\r\n\r\nfunction reset_sales_partner(frm){\r\n    frm.set_value(\"sales_partner\",\"\")\r\n    frm.set_value(\"commission_rate\",0);\r\n    frm.set_value(\"total_commission\",0);\r\n}\r\n\r\nfunction get_payment_balance(frm){\r\n    var total_payments = 0;\r\n    var grand_total = frm.doc.custom_amount_due;\r\n    var invoice_payments = frm.doc.custom_invoice_payments;\r\n    var balance_amount = 0;\r\n\r\n    for(var i=0; i<invoice_payments.length; i++){\r\n        if(typeof invoice_payments[i]==\"undefined\"){\r\n        }\r\n        else{\r\n            if(\"amount\" in invoice_payments[i])\r\n                if(invoice_payments[i].amount>0)\r\n                    total_payments += invoice_payments[i].amount;\r\n        }\r\n\r\n    }\r\n\r\n    balance_amount = grand_total - total_payments;\r\n\r\n    for(var j=0; j<invoice_payments.length; j++){\r\n        console.log(invoice_payments[j].amount+\"| invoice_pmt amount\");\r\n        if((invoice_payments[j].amount == undefined)||(invoice_payments[j].amount==0))\r\n            frappe.model.set_value(invoice_payments[j].doctype, invoice_payments[j].name, 'amount', balance_amount)\r\n        frm.refresh_field('custom_invoice_payments');\r\n    }\r\n\r\n    update_payment_balance(frm);\r\n\r\n}\r\n\r\n\r\nfunction update_payment_balance(frm){\r\n    var total_payments = 0;\r\n    var grand_total = frm.doc.grand_total;\r\n    var invoice_payments = frm.doc.custom_invoice_payments;\r\n    var balance_amount = 0;\r\n\r\n    for(var i=0; i<invoice_payments.length; i++){\r\n            total_payments += invoice_payments[i].amount;\r\n    }\r\n\r\n    frm.set_value(\"custom_payments_total\", total_payments);\r\n\r\n}\r\n\r\nfunction add_employee_benefit_row(frm, amount){\r\n\tvar row = frm.add_child(\"custom_invoice_payments\");\r\n\trow.payment_mode = \"Employee Benefit\";\r\n\trow.amount = amount;\r\n\tfrm.refresh_field('custom_invoice_payments');\r\n\tconsole.log(\"Add Emp. Benefit row.\")\r\n}\r\n",
  "view": "Form"
 },
 {
  "docstatus": 0,
  "doctype": "Client Script",
  "dt": "Lab Test",
  "enabled": 1,
  "modified": "2024-05-12 20:23:10.572834",
  "module": "Healthcare Add-ons",
  "name": "Lab Test Script",
  "script": "cur_frm.add_fetch(\"custom_sales_invoice\",\"patient\",\"patient\")\n\nfrappe.ui.form.on('Lab Test', {\n\trefresh(frm) {\n\t\tfrm.set_query(\"custom_radiologist\", function() {\n        return {\n            \"filters\": {\n                \"custom_type\": \"Radiologist\"\n            }\n        };\n    });\n    \t\tfrm.set_query(\"custom_sales_invoice\", function() {\n        return {\n            \"filters\": {\n                \"docstatus\": \"1\"\n            }\n        };\n    });\n\t}\n})\n\nfrappe.ui.form.on(\"Lab Test\",\"custom_radiologist\",function(frm){\n    if(frm.doc.custom_radiologist)\n    frappe.call({\n        \"method\":\"frappe.client.get\",\n        \"args\":{\n            \"doctype\":\"Healthcare Practitioner\",\n            \"name\":frm.doc.custom_radiologist\n        },\n        callback:function(r){\n            if(r.message){\n                frm.set_value(\"custom_radiologist_name\",r.message.practitioner_name)\n            }\n        }\n    });\n    else{\n        frm.set_value(\"custom_radiologist_name\",\"\")\n    }\n})",
  "view": "Form"
 }
]